<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Marvel API Test</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        max-width: 800px;
        margin: 0 auto;
        padding: 20px;
        background: #1a1a1a;
        color: #fff;
      }
      .status {
        padding: 10px;
        margin: 10px 0;
        border-radius: 5px;
      }
      .success {
        background: #1b5e20;
      }
      .error {
        background: #c62828;
      }
      .warning {
        background: #ef6c00;
      }
      pre {
        background: #333;
        padding: 10px;
        border-radius: 5px;
        overflow-x: auto;
      }
      button {
        background: #ed1d24;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 5px;
        cursor: pointer;
        margin: 5px;
      }
      button:hover {
        background: #c41e3a;
      }
    </style>
  </head>
  <body>
    <h1>üîß Marvel API Configuration Test</h1>

    <div class="status warning">
      <strong>‚ö†Ô∏è Instru√ß√µes:</strong>
      <p>1. Configure suas chaves no arquivo .env</p>
      <p>
        2. No painel Marvel, use apenas <strong>"localhost"</strong> (sem porta)
        como referenciador
      </p>
      <p>3. Clique em "Testar API" para verificar se est√° funcionando</p>
    </div>

    <button onclick="testMarvelAPI()">üß™ Testar API</button>
    <button onclick="testWithoutPort()">üåê Testar sem Porta</button>
    <button onclick="clearResults()">üóëÔ∏è Limpar Resultados</button>

    <div id="results"></div>

    <script>
      // Fun√ß√£o para criar hash MD5 (vers√£o simplificada para teste)
      function md5(str) {
        // Para teste, usaremos crypto.subtle ou uma implementa√ß√£o simples
        // Em produ√ß√£o, use a biblioteca md5 do npm
        return btoa(str)
          .replace(/[^a-z0-9]/gi, "")
          .toLowerCase()
          .substring(0, 32);
      }

      function generateAuthParams(publicKey, privateKey) {
        const ts = Date.now().toString();
        const hash = md5(ts + privateKey + publicKey);
        return { ts, apikey: publicKey, hash };
      }

      function showResult(type, title, content) {
        const results = document.getElementById("results");
        const div = document.createElement("div");
        div.className = `status ${type}`;
        div.innerHTML = `<strong>${title}</strong><pre>${content}</pre>`;
        results.appendChild(div);
      }

      function clearResults() {
        document.getElementById("results").innerHTML = "";
      }

      async function testMarvelAPI() {
        showResult(
          "warning",
          "üîÑ Iniciando Teste",
          "Verificando configura√ß√£o da Marvel API..."
        );

        // Tentar ler vari√°veis de ambiente (simulado)
        const publicKey = "your_public_key_here"; // Substituir pela sua chave real
        const privateKey = "your_private_key_here"; // Substituir pela sua chave real

        if (publicKey === "your_public_key_here") {
          showResult(
            "error",
            "‚ùå Erro de Configura√ß√£o",
            "Chaves n√£o configuradas!\n\n" +
              "Passos para corrigir:\n" +
              "1. Copie .env.example para .env\n" +
              "2. Adicione suas chaves da Marvel\n" +
              "3. Reinicie o servidor"
          );
          return;
        }

        try {
          const authParams = generateAuthParams(publicKey, privateKey);
          const url = `https://gateway.marvel.com/v1/public/characters?limit=1&${new URLSearchParams(
            authParams
          )}`;

          showResult(
            "warning",
            "üåê Fazendo Requisi√ß√£o",
            `URL: ${url.replace(privateKey, "[PRIVATE_KEY_HIDDEN]")}`
          );

          const response = await fetch(url);
          const data = await response.json();

          if (response.ok) {
            showResult(
              "success",
              "‚úÖ Sucesso!",
              `Status: ${response.status}\n` +
                `Total de her√≥is dispon√≠veis: ${data.data.total}\n` +
                `Primeiro her√≥i: ${data.data.results[0]?.name || "N/A"}`
            );
          } else {
            showResult(
              "error",
              "‚ùå Erro da API",
              `Status: ${response.status}\n` +
                `Erro: ${data.status || data.message}\n\n` +
                "Poss√≠veis solu√ß√µes:\n" +
                "‚Ä¢ Verificar se localhost est√° nos referenciadores autorizados\n" +
                "‚Ä¢ Verificar se as chaves est√£o corretas\n" +
                "‚Ä¢ Tentar acessar via 127.0.0.1"
            );
          }
        } catch (error) {
          showResult(
            "error",
            "‚ùå Erro de Rede",
            `Erro: ${error.message}\n\n` +
              "Poss√≠veis causas:\n" +
              "‚Ä¢ Problema de CORS\n" +
              "‚Ä¢ Referenciador n√£o autorizado\n" +
              "‚Ä¢ Conex√£o com internet"
          );
        }
      }

      async function testWithoutPort() {
        showResult(
          "warning",
          "üîß Teste sem Porta",
          "Este teste simula o acesso sem especificar porta.\n" +
            'Recomendado: use apenas "localhost" nos referenciadores Marvel.'
        );

        // Simular teste sem porta
        setTimeout(() => {
          testMarvelAPI();
        }, 1000);
      }

      // Mostrar informa√ß√µes iniciais
      window.onload = function () {
        showResult(
          "warning",
          "üìã Configura√ß√£o Atual",
          `Dom√≠nio atual: ${window.location.hostname}\n` +
            `Porta atual: ${window.location.port}\n` +
            `URL completa: ${window.location.href}\n\n` +
            "No painel Marvel, configure:\n" +
            `‚Ä¢ ${window.location.hostname} (sem porta)`
        );
      };
    </script>
  </body>
</html>
